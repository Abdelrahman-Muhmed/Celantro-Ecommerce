@model EcommerceCoffee_BLL.DTOs.loginDto

@{
    ViewBag.Title = "Login";
    Layout = "~/Views/Shared/_AuthLayout.cshtml"; 
}




@using (Html.BeginForm("Login", "Account", FormMethod.Post, new { @class = "form-horizontal", id = "loginForm" }))
{
    <div class="form-horizontal">
        <h4>Login</h4>
        <hr />
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger text-center mb-3" })

        <!-- Email -->
        <div class="form-group row">
            @Html.LabelFor(model => model.Email, htmlAttributes: new { @class = "control-label col-md-2 col-form-label" })
            <div class="col-md-10">
                @Html.TextBoxFor(model => model.Email, new { @class = "form-control", id= "emailId" })
                @Html.ValidationMessageFor(model => model.Email, "", new { @class = "text-danger" })
            </div>
        </div>

        <!-- Password -->
        <div class="form-group row">
            @Html.LabelFor(model => model.PassWord, htmlAttributes: new { @class = "control-label col-md-2 col-form-label" })
            <div class="col-md-10">
                @Html.TextBoxFor(model => model.PassWord, new { @class = "form-control", type="password", id= "passWordId" })
                @Html.ValidationMessageFor(model => model.PassWord, "", new { @class = "text-danger" })
            </div>
        </div>

        @* Submit Button *@
    <div class="form-group row">
        <div class="col-md-offset-2 col-md-10">
            <input type="submit" value="Login" class="button" id="loginBtn" />
            <a href="@Url.Action("Register", "Account")" class="btn button m-1">Join Us</a>
        </div>
    </div>
        <div>
            
            <label>
                <input type="checkbox" id="checkId" name="rememberMe"/>
                Remeber Me 
            </label>
        </div>
       
        <div id="message" class="text-danger mt-2 text-center"></div>
    </div>
}

        @section scripts {
            <script>
                //Start Login
                $(document).ready(function () {
                    $("#loginBtn").click(function (e) {
                        e.preventDefault();

                        var email = $("#emailId").val();
                        var passWord = $("#passWordId").val();
                        var check = $("#checkId").is(":checked"); 


                       

                        var secretKey = "b14ca5898a4e4133bbce2ea2315a1916";
                        var encryptedPassword;


                        if (!email || !passWord) {
                            $("#message").text("Both email and password are required.");
                            return;
                        }

                        // First AJAX call for encryption
                        $.ajax({
                            type: "POST",
                            url: "/Encrypt/EncryptPath",
                            data: { key: secretKey, plainText: passWord },
                            success: function (response) {
                                encryptedPassword = response.encryptedString;
                                console.log(encryptedPassword);
                                console.log(passWord);
                                console.log(check);


                                $.ajax({
                                    type: "POST",
                                    url: "/Account/Login",
                                    data: { Email: email, passWord: encryptedPassword, remeberMe:check}, 
                                    success: function (response) {
                                        //console.log(response);
                                        console.log("Error")

                                        window.location.href = '/Category/Index';
                                        // Store the token in sessionStorage
                                        sessionStorage.setItem('authToken', response.token);
                                    },
                                    error: function () {
                                        $("#message").text("Email or Password Wrong. Please try again.");
                                    }
                                });
                            },
                            error: function (xhr, status, error) {
                                alert("Error: " + xhr.responseText);
                            }
                        });
                    });
                });
                //End Login
            </script>
        }
